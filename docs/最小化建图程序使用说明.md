# æœ€å°åŒ–å»ºå›¾éªŒè¯ç¨‹åºä½¿ç”¨è¯´æ˜

## ğŸ“‹ åŠŸèƒ½è¯´æ˜

è¿™æ˜¯ä¸€ä¸ª**æœ€å°åŒ–çš„å»ºå›¾éªŒè¯ç¨‹åº**ï¼Œä¸“é—¨ç”¨äºæµ‹è¯•å’ŒéªŒè¯è¯­ä¹‰å»ºå›¾åŠŸèƒ½ã€‚

### æ ¸å¿ƒåŠŸèƒ½
1. âœ… åˆå§‹åŒ–å•ä¸ª Habitat ç¯å¢ƒ
2. âœ… ç¯è§† 360Â° (12 æ­¥ Ã— 30Â° = 360Â°)
3. âœ… è¯­ä¹‰åˆ†å‰² (GroundedSAM)
4. âœ… è¯­ä¹‰åœ°å›¾æ„å»º
5. âœ… ä¿å­˜æ‰€æœ‰åœ°å›¾æ•°æ®å’Œå¯è§†åŒ–

### ä¸å®Œæ•´ç¨‹åºçš„åŒºåˆ«
| åŠŸèƒ½ | å®Œæ•´ç¨‹åº (ZS_Evaluator_mp.py) | æœ€å°åŒ–ç¨‹åº (minimal_mapping_test.py) |
|------|------------------------------|-------------------------------------|
| å¤šè¿›ç¨‹ | âœ… 16 è¿›ç¨‹å¹¶è¡Œ | âŒ å•è¿›ç¨‹ |
| å¯¼èˆªå¾ªç¯ | âœ… 500 æ­¥å¯¼èˆª | âŒ åªç¯è§† |
| æŒ‡ä»¤åˆ†è§£ | âœ… LLM æŒ‡ä»¤è§£æ | âŒ ä¸éœ€è¦ |
| çº¦æŸç›‘æ§ | âœ… å­ä»»åŠ¡åˆ‡æ¢ | âŒ ä¸éœ€è¦ |
| è·¯å¾„è§„åˆ’ | âœ… FMM + ä»·å€¼å›¾ | âŒ ä¸éœ€è¦ |
| åœ°å›¾ä¿å­˜ | âŒ åªä¿å­˜æŒ‡æ ‡ | âœ… ä¿å­˜å®Œæ•´åœ°å›¾ |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ç”¨æ³•
```bash
cd /Volumes/T9/project/vln_ws/CA-Nav-code

# ä½¿ç”¨é»˜è®¤é…ç½®
python minimal_mapping_test.py --exp-config vlnce_baselines/config/exp1.yaml

# æŒ‡å®š GPU
python minimal_mapping_test.py \
    --exp-config vlnce_baselines/config/exp1.yaml \
    TORCH_GPU_ID 0

# ä¿®æ”¹åœ°å›¾åˆ†è¾¨ç‡
python minimal_mapping_test.py \
    --exp-config vlnce_baselines/config/exp1.yaml \
    MAP.MAP_RESOLUTION 10
```

### 2. è¾“å‡ºç»“æœ

ç¨‹åºä¼šåœ¨ `data/minimal_mapping_test/` ç›®å½•ä¸‹ç”Ÿæˆï¼š

```
data/minimal_mapping_test/
â”œâ”€â”€ maps/                          # åœ°å›¾æ¼”åŒ–è¿‡ç¨‹
â”‚   â”œâ”€â”€ map_step_00.png           # ç¬¬1æ­¥åœ°å›¾
â”‚   â”œâ”€â”€ map_step_01.png           # ç¬¬2æ­¥åœ°å›¾
â”‚   â””â”€â”€ ...
â”œâ”€â”€ rgb/                           # RGB å›¾åƒ
â”‚   â”œâ”€â”€ step_00.png               # åŸå§‹ RGB
â”‚   â”œâ”€â”€ step_00_annotated.png     # æ ‡æ³¨åçš„ RGB (GroundedSAM)
â”‚   â””â”€â”€ ...
â”œâ”€â”€ depth/                         # æ·±åº¦å›¾
â”‚   â”œâ”€â”€ step_00.png
â”‚   â””â”€â”€ ...
â”œâ”€â”€ maps_history.npy              # å®Œæ•´åœ°å›¾å†å² (numpy æ•°ç»„)
â””â”€â”€ final_map.png                 # æœ€ç»ˆåœ°å›¾å¯è§†åŒ–
```

---

## ğŸ“Š è¾“å‡ºè¯´æ˜

### 1. åœ°å›¾é€šé“ç»“æ„
`maps_history.npy` åŒ…å«æ¯ä¸€æ­¥çš„å®Œæ•´åœ°å›¾ï¼Œå½¢çŠ¶ä¸º `(N+4, 480, 480)`:

| é€šé“ | åç§° | è¯´æ˜ |
|------|------|------|
| 0 | Obstacles | éšœç¢ç‰©åœ°å›¾ (å¢™å£ã€å®¶å…·ç­‰) |
| 1 | Explored Area | å·²æ¢ç´¢åŒºåŸŸ |
| 2 | Current Location | å½“å‰æ™ºèƒ½ä½“ä½ç½® (3Ã—3 åŒºåŸŸ) |
| 3 | Past Locations | å†å²è®¿é—®åŒºåŸŸ |
| 4+ | Semantic Classes | åŠ¨æ€è¯­ä¹‰ç±»åˆ« (floor, wall, door, kitchen, ...) |

### 2. å¯è§†åŒ–è¯´æ˜

**final_map.png** åŒ…å« 6 ä¸ªå­å›¾ï¼š
- å·¦ä¸Š: éšœç¢ç‰©åœ°å›¾ (ç°è‰²)
- ä¸­ä¸Š: å·²æ¢ç´¢åŒºåŸŸ (è“è‰²)
- å³ä¸Š: å½“å‰ä½ç½® (çº¢è‰²)ï¼ŒåŒ…å«ä½å§¿æ ‡è®°
- å·¦ä¸‹: å†å²è½¨è¿¹ (ç»¿è‰²)
- ä¸­ä¸‹: åœ°æ¿è¯­ä¹‰ (é»„è‰²)
- å³ä¸‹: ç»¼åˆåœ°å›¾ (RGB å åŠ )

### 3. æ§åˆ¶å°è¾“å‡ºç¤ºä¾‹
```
[INFO] è¾“å‡ºç›®å½•: data/minimal_mapping_test
[INFO] åœ°å›¾å°ºå¯¸: (480, 480)
[INFO] åœ°å›¾åˆ†è¾¨ç‡: 5 cm/pixel

[STEP 1] åˆå§‹åŒ– Habitat ç¯å¢ƒ...
[INFO] Episode ID: 1001
[INFO] åœºæ™¯: data/scene_datasets/mp3d/17DRP5sb8fy/17DRP5sb8fy.glb

[STEP 2] åˆå§‹åŒ–å»ºå›¾æ¨¡å—...
[INFO] GroundedSAM åˆå§‹åŒ–å®Œæˆ
[INFO] Semantic_Mapping åˆå§‹åŒ–å®Œæˆ

[STEP 3] ç¯è§† 360Â° å»ºå›¾...

[STEP 3.1] å·¦è½¬ 30Â° (æ€»è®¡ 30Â°)...
[INFO] æ£€æµ‹åˆ°ç±»åˆ«: ['floor 0.85', 'wall 0.72', 'door 0.63']
[INFO] ä½å§¿: [12.00, 12.00, 0.52]
[INFO] åœ°å›¾å½¢çŠ¶: (1, 7, 480, 480)

...

[STEP 4] ä¿å­˜åœ°å›¾...
[INFO] ä¿å­˜åœ°å›¾å†å²: data/minimal_mapping_test/maps_history.npy
[INFO] ä¿å­˜æœ€ç»ˆåœ°å›¾å¯è§†åŒ–: data/minimal_mapping_test/final_map.png
[INFO] ç”Ÿæˆåœ°å›¾æ¼”åŒ–åŠ¨ç”»...
[INFO] ä¿å­˜åœ°å›¾æ¼”åŒ–: data/minimal_mapping_test/maps/map_step_*.png

==================================================
å»ºå›¾ç»Ÿè®¡ä¿¡æ¯
==================================================
Episode ID: 1001
æ£€æµ‹åˆ°çš„ç±»åˆ«æ•°: 8
ç±»åˆ«åˆ—è¡¨: ['floor', 'wall', 'door', 'window', 'table', 'chair', 'bed', 'cabinet']
æœ€ç»ˆä½å§¿: [12.00, 12.00, 0.00]
åœ°å›¾å°ºå¯¸: (11, 480, 480)
å·²æ¢ç´¢åƒç´ æ•°: 18542
éšœç¢ç‰©åƒç´ æ•°: 3821
==================================================

[SUCCESS] æµ‹è¯•å®Œæˆï¼
[INFO] æŸ¥çœ‹ç»“æœ: data/minimal_mapping_test/
```

---

## ğŸ”§ ä»£ç ç»“æ„

```python
class MinimalMappingTest:
    def __init__(self, config):
        """åˆå§‹åŒ–é…ç½®å’Œç›®å½•"""
        
    def initialize_environment(self):
        """åˆå§‹åŒ– Habitat ç¯å¢ƒ"""
        # - construct_envs()
        # - envs.reset()
        
    def initialize_modules(self):
        """åˆå§‹åŒ–å»ºå›¾æ¨¡å—"""
        # - GroundedSAM (è¯­ä¹‰åˆ†å‰²)
        # - Semantic_Mapping (è¯­ä¹‰åœ°å›¾)
        
    def preprocess_observation(self, obs):
        """é¢„å¤„ç†è§‚å¯Ÿï¼šè¯­ä¹‰åˆ†å‰²"""
        # - RGB + Depth â†’ State
        # - GroundedSAM åˆ†å‰²
        # - ä¸‹é‡‡æ ·åˆ° 160Ã—160
        
    def look_around_and_map(self):
        """ç¯è§† 360Â° å¹¶å»ºå›¾"""
        # - å¾ªç¯ 12 æ¬¡ï¼Œæ¯æ¬¡å·¦è½¬ 30Â°
        # - è¯­ä¹‰åˆ†å‰²
        # - mapping_module(batch_obs, poses)
        # - mapping_module.update_map()
        
    def save_maps(self, maps_history):
        """ä¿å­˜åœ°å›¾æ•°æ®å’Œå¯è§†åŒ–"""
        # - ä¿å­˜ .npy æ–‡ä»¶
        # - ç”Ÿæˆå¯è§†åŒ–å›¾åƒ
        
    def run(self):
        """è¿è¡Œå®Œæ•´æµ‹è¯•"""
```

---

## ğŸ“ ä½¿ç”¨åœºæ™¯

### 1. éªŒè¯è¯­ä¹‰åˆ†å‰²
æ£€æŸ¥ GroundedSAM æ˜¯å¦æ­£ç¡®æ£€æµ‹ç‰©ä½“ï¼š
```bash
python minimal_mapping_test.py --exp-config vlnce_baselines/config/exp1.yaml
# æŸ¥çœ‹: data/minimal_mapping_test/rgb/step_*_annotated.png
```

### 2. éªŒè¯å»ºå›¾ç®—æ³•
æ£€æŸ¥åœ°å›¾æ˜¯å¦æ­£ç¡®ç´¯ç§¯ï¼š
```bash
# æŸ¥çœ‹åœ°å›¾æ¼”åŒ–
ls data/minimal_mapping_test/maps/map_step_*.png
# æˆ–æŸ¥çœ‹æœ€ç»ˆåœ°å›¾
open data/minimal_mapping_test/final_map.png
```

### 3. è°ƒè¯•åæ ‡ç³»
æ£€æŸ¥ä½å§¿å˜æ¢æ˜¯å¦æ­£ç¡®ï¼š
```python
import numpy as np

# åŠ è½½åœ°å›¾å†å²
maps_history = np.load('data/minimal_mapping_test/maps_history.npy', allow_pickle=True)

# æŸ¥çœ‹æ¯ä¸€æ­¥çš„ä½å§¿
for i, m in enumerate(maps_history):
    pose = m['full_pose'][0]
    print(f"Step {i}: x={pose[0]:.2f}, y={pose[1]:.2f}, Î¸={pose[2]:.2f}")
```

### 4. æ€§èƒ½æµ‹è¯•
æµ‹é‡å»ºå›¾é€Ÿåº¦ï¼š
```bash
time python minimal_mapping_test.py --exp-config vlnce_baselines/config/exp1.yaml
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æ˜¾å­˜ä¸è¶³
**é—®é¢˜**: CUDA out of memory

**è§£å†³**:
```bash
# ä½¿ç”¨æ›´å°çš„åœ°å›¾
python minimal_mapping_test.py \
    --exp-config vlnce_baselines/config/exp1.yaml \
    MAP.MAP_SIZE_CM 1200
```

### Q2: æ²¡æœ‰æ£€æµ‹åˆ°ç‰©ä½“
**é—®é¢˜**: `æ£€æµ‹åˆ°ç±»åˆ«: []`

**è§£å†³**:
- é™ä½æ£€æµ‹é˜ˆå€¼: `MAP.BOX_THRESHOLD 0.15`
- æ£€æŸ¥ GroundedSAM æƒé‡æ˜¯å¦æ­£ç¡®åŠ è½½

### Q3: åœ°å›¾å…¨é»‘
**é—®é¢˜**: åœ°å›¾æ²¡æœ‰ä»»ä½•å†…å®¹

**è§£å†³**:
- æ£€æŸ¥æ·±åº¦å›¾æ˜¯å¦æœ‰æ•ˆ: `data/minimal_mapping_test/depth/step_00.png`
- æ£€æŸ¥ sensor_pose æ˜¯å¦ä¸º 0: æ‰“å° `obs['sensor_pose']`

---

## ğŸ”„ ä¸å®Œæ•´ç¨‹åºçš„å¯¹æ¯”

### ä»æœ€å°åŒ–ç¨‹åºåˆ°å®Œæ•´ç¨‹åº

```python
# æœ€å°åŒ–ç¨‹åº (minimal_mapping_test.py)
for step in range(12):
    action = TURN_LEFT
    obs = envs.step(action)
    mapping_module(obs, poses)
    save_map()

# â†“ æ·»åŠ åŠŸèƒ½ â†“

# å®Œæ•´ç¨‹åº (ZS_Evaluator_mp.py)
for step in range(12, 500):
    # + çº¦æŸæ£€æŸ¥
    check = constraints_monitor(...)
    
    # + å­ä»»åŠ¡åˆ‡æ¢
    if constraint_satisfied:
        switch_to_next_task()
    
    # + ä»·å€¼å›¾è®¡ç®—
    value_map = value_map_module(...)
    
    # + è·¯å¾„è§„åˆ’
    action = policy(value_map, ...)
    
    obs = envs.step(action)
    mapping_module(obs, poses)
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **å®Œæ•´å»ºå›¾æµç¨‹**: `docs/è¯­ä¹‰åœ°å›¾ç”Ÿæˆä¸æ›´æ–°æµç¨‹.md`
- **rollout å‡½æ•°è¯¦è§£**: `docs/rolloutå‡½æ•°è¯¦è§£.md`
- **å®Œæ•´è¯„ä¼°ç¨‹åº**: `run_mp.py` + `ZS_Evaluator_mp.py`

---

**åˆ›å»ºæ—¶é—´**: 2025-11-08
