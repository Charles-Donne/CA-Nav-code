# 地图融合机制 - 简明版

## 旋转方案：12次 × 30° = 360°

```
智能体位置固定，原地旋转拍摄12张照片：

  0°     30°    60°    90°   120°   150°   180°   210°   240°   270°   300°   330°
  👁→    👁↗    👁↑    👁↖   👁←    👁↙    👁↓    👁↘    👁→    ...
  照片1   照片2  照片3  照片4  照片5  照片6  照片7  照片8  照片9  照片10 照片11 照片12
```

恰好覆盖完整360°，每个方向都有观察。

---

## 地图融合过程

### 第1步：深度投影（每张照片独立处理）

```python
相机观察 (RGB + Depth + Semantic)
     ↓
点云投影（深度 → 3D坐标）
     ↓
坐标变换（相机坐标系 → 世界坐标系，使用当前朝向角度θ）
     ↓
栅格化（3D点 → 2D地图网格，5cm/pixel）
     ↓
更新局部地图 (240×240)
```

**关键**：每次旋转后，`poses` 参数包含新的朝向角 `θ`，mapping模块会自动使用旋转矩阵对齐到世界坐标系！

```python
# 坐标变换公式
world_x = agent_x + cos(θ)*cam_x - sin(θ)*cam_y
world_y = agent_y + sin(θ)*cam_x + cos(θ)*cam_y
```

### 第2步：局部地图 → 全局地图

```python
# 每次拍照后都会执行：
full_map[:, lmb[0]:lmb[1], lmb[2]:lmb[3]] = local_map
```

这是**直接覆盖**，因为局部地图已经包含了最新的累积结果。

### 第3步：重叠区域的累积

**重要**：地图是**累积更新**的，不是简单替换！

```python
# 在投影时（forward方法中）：
if 检测到障碍物:
    local_map[0, y, x] += 1  # 障碍物计数累加
    
local_map[1, y, x] = 1  # 探索标记（二值）

if 检测到物体i:
    local_map[4+i, y, x] += confidence  # 语义置信度累加
```

### 可视化效果

```
第1次 (0°)         第4次 (90°)        第7次 (180°)       第10次 (270°)
     →                 ↑                  ←                  ↓
┌─────────┐       ┌─────────┐       ┌─────────┐       ┌─────────┐
│ ███     │       │ ███████ │       │ ███████ │       │ ███████ │
│ ███ 🤖  │   →   │ ███████ │   →   │ ███████ │   →   │ ███████ │
│         │       │  🤖     │       │     🤖  │       │ ███ 🤖  │
└─────────┘       └─────────┘       └─────────┘       └─────────┘

                    融合后的全局地图
               ┌───────────────────────┐
               │                       │
               │   ███████████████     │
               │   ███████████████     │  ← 12个方向的观察
               │   ███████████████     │     全部融合
               │   ███████🤖█████      │
               │   ███████████████     │
               │                       │
               └───────────────────────┘
```

---

## 核心机制总结

1. **智能体不动**：只旋转，位置 (x, y) 保持不变
2. **自动对齐**：每次旋转后，mapping模块用旋转矩阵 R(θ) 自动对齐坐标系
3. **累积更新**：
   - 障碍物：多次观察 → 计数增加 → 置信度提高
   - 探索区域：只要观察过就标记为1
   - 语义信息：置信度累加
4. **无缝融合**：12次观察自动融合成完整的360°全景地图

---

## 配色方案

| 元素 | 颜色 | RGB |
|-----|------|-----|
| 未探索 | 白色 | (255,255,255) |
| 地面 | 浅蓝 | (173,216,230) |
| 障碍物 | 深红 | (139,0,0) |
| 智能体箭头 | 深蓝 | (0,0,139) |

---

## 输出文件

```
data/minimal_mapping_test/
├── maps/
│   ├── map_step_00.png  # 0°
│   ├── map_step_01.png  # 30°
│   ├── map_step_02.png  # 60°
│   ├── map_step_03.png  # 90°
│   ├── map_step_04.png  # 120°
│   ├── map_step_05.png  # 150°
│   ├── map_step_06.png  # 180°
│   ├── map_step_07.png  # 210°
│   ├── map_step_08.png  # 240°
│   ├── map_step_09.png  # 270°
│   ├── map_step_10.png  # 300°
│   └── map_step_11.png  # 330°
└── maps_history.npy     # 原始数据
```

每张图片包含：
- **左侧**：全局地图 (480×480, 24m×24m)
- **右侧**：局部地图 (240×240, 12m×12m)
- **红框**：局部地图在全局地图中的位置
- **深蓝箭头**：智能体朝向
